---
import { Button } from "@/components/ui/button";
import { Card } from "@/components/ui/card";
import { Container } from "@/components/ui/container";
import { Hint } from "@/components/ui/hint";
import { Input } from "@/components/ui/input";
import { Stack } from "@/components/ui/stack";
import Layout from "@/layouts/DefaultLayout.astro";
import { ArrowLeftIcon } from "@radix-ui/react-icons";
import { getEntry, type CollectionEntry } from "astro:content";

export const prerender = false;

const id = new URL(Astro.request.url).searchParams.get("id");
let error = false;
let diploma: CollectionEntry<"diplomas"> | undefined;


if (id) {
	diploma = await getEntry("diplomas", id.toUpperCase());

	if (!diploma) {
		error = true;
	}

	if (diploma && diploma.data.status === "cancelled") {
		error = true;
	}
}
---

<Layout title="Check diploma">
	<Container>
		<Stack>
			<h1
				class="text-5xl font-bold"
			>
				Check diploma
			</h1>
			<p>This is an online tool to verify diploma's issued by Roseto.</p>

			{id 
				? 
					<>
						<Card className="p-8">
							<p class="text-muted-foreground text-sm">Diploma with id:</p>
							<h2 class="text-7xl font-bold">{id.toUpperCase()}</h2>
							<p
								class:list={["text-2xl font-bold", error ? "text-destructive" : "text-green-400"]}
							>
								IS {error ? "NOT" : ""} VALID
							</p>
							{diploma && 
								<p>This diploma was issued for <span class="font-bold">{diploma.data.name}</span></p>
							}
						</Card>
						<a href="/check">
							<Button 
								variant="outline"
								className="w-full"
							>
								<ArrowLeftIcon className="mr-2 h-4 w-4" />
								Check another diploma ID
							</Button>
						</a>
					</>
				:
					<form method="get">
						<Input
							name="id"
							type="text"
							required
							autoComplete="off"
							autoCapitalize="on"
							autoCorrect="off"
							autoFocus
							className="text-8xl !p-16 !text-center uppercase"
							pattern="[A-Za-z1-9]{3}"
							maxLength={3}
							minLength={3}
						/>
						<Hint className="mt-1">
							The ID is made up of 3 characters containing letters A to Z and numbers 1 to 9.
						</Hint>

						<Button
							className="mt-4 w-full"
							type="submit"
						>
							Check
						</Button>
					</form>
			}
		</Stack>
	</Container>
</Layout>
